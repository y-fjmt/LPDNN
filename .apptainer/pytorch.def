Bootstrap: localimage
From: .apptainer/ngc_pytorch_2505.sif

%environment
    export LC_ALL=C
    export LC_CTYPE=C
    export HF_HOME="/workspace/.cache/huggingface"
    export DEBIAN_FRONTEND=noninteractive

%files
    requirements.txt

%post
    apt update -y 

    pip install -r requirements.txt
    
    # Megatron-LM
    cd /opt
    git clone https://github.com/NVIDIA/Megatron-LM.git
    cd Megatron-LM
    pip install -e .

    # NVIDIA APEX
    cd /opt
    git clone https://github.com/NVIDIA/apex
    cd apex
    MAX_JOBS=$(nproc) \
    NVCC_APPEND_FLAGS="--threads 4" \
    pip install -v \
        --disable-pip-version-check \
        --no-cache-dir --no-build-isolation \
        --config-settings "--build-option=--cpp_ext --cuda_ext --parallel 8" ./
    
    # Transformer Engine
    pip install \
        --no-build-isolation transformer_engine[pytorch]

    apt clean
    rm -rf /var/lib/apt/lists/*

    cd /usr/local/cuda/compat
    if [ ! -e lib ]; then
        ln -s lib.real lib
    fi
